"""
Module for handling API calls to the [AlgoBulls](https://www.algobulls.com) backend
"""

from json import JSONDecodeError

import requests

from .exceptions import AlgoBullsAPIBaseException, AlgoBullsAPIUnauthorizedError, AlgoBullsAPIResourceNotFoundError, AlgoBullsAPIBadRequest, AlgoBullsAPIInternalServerErrorException
from ..constants import StrategyType


class AlgoBullsAPI:
    SERVER_ENDPOINT = 'http://127.0.0.1:8000/'

    def __init__(self):
        self.headers = None

    def set_access_token(self, access_token: str):
        """
        Sets access token to the header attribute, which is needed for APIs requiring authorization
        Package for interacting with AlgoBulls Algorithmic Trading Platform (https://www.algobulls.com)

        Args:
            access_token: Access token generated by logging to the URL given by the `get_authorization_url()` method
        """
        self.headers = {
            'Authorization': f'Token {access_token}'
        }

    def _send_request(self, method: str = 'get', endpoint: str = '', base_url: str = SERVER_ENDPOINT, params: [str, dict] = None, form_data: [str, dict] = None, requires_authorization: bool = True) -> dict:
        url = f'{base_url}{endpoint}'
        headers = self.headers if requires_authorization else None
        response = requests.request(method=method, headers=headers, url=url, params=params, data=form_data)

        try:
            response_json = response.json()
        except JSONDecodeError:
            response_json = str(response)

        if response.status_code == 200:
            response_json = response.json()
            return response_json
        elif response.status_code == 400:
            raise AlgoBullsAPIBadRequest(f'Bad Request --> Method: {method} | URL: {url} | Response: {response_json}')
        elif response.status_code == 401:
            raise AlgoBullsAPIUnauthorizedError(f'Unauthorized Error --> Method: {method} | URL: {url} | Response: {response_json}')
        elif response.status_code == 404:
            raise AlgoBullsAPIResourceNotFoundError(f'API Not Found --> Method: {method} | URL: {url} | Response: {response_json}')
        elif response.status_code == 500:
            raise AlgoBullsAPIInternalServerErrorException(f'Internal Server Error --> Method: {method} | URL: {url} | Response: {response_json}')
        else:
            response.raw.decode_content = True
            raise AlgoBullsAPIBaseException(f'Unknown non-200 status code --> Method: {method} | URL: {url} | Response: {response_json} | Response code: {response.status_code}')

    def create_strategy(self, strategy_name: str, strategy_details: str, abc_version: str) -> dict:
        """
        Create a new strategy for the user on the AlgoBulls platform.

        Args:
            strategy_name: name of the strategy
            strategy_details: Python code of the strategy
            abc_version: value of one of the enums available under [AlgoBullsEngineVersion]()

        Returns:
            JSON Response received from AlgoBulls platform after (attempt to) creating a new strategy.

        Warning:
            For every user, the `strategy_name` should be unique. You cannot create multiple strategies with the same name.

        Info: ENDPOINT
            `POST` v1/build_python_strategy
        """
        form_data = {'strategy_name': strategy_name, 'strategy_details': strategy_details, 'abc_version': abc_version}
        endpoint = f'v1/build_python_strategy'
        response = self._send_request(endpoint=endpoint, method='post', form_data=form_data)
        return response

    def update_strategy(self, strategy_name: str, strategy_details: str, abc_version: str) -> dict:
        """
        Update an already existing strategy on the AlgoBulls platform

        Args:
            strategy_name: name of the strategy
            strategy_details: Python code of the strategy
            abc_version: value of one of the enums available under `AlgoBullsEngineVersion`

        Returns:
            JSON Response received from AlgoBulls platform after (attempt to) updating an existing strategy.

        Info: ENDPOINT
            PUT v1/build_python_strategy
        """
        form_data = {'strategy_name': strategy_name, 'strategy_details': strategy_details, 'abc_version': abc_version}
        endpoint = f'v1/build_python_strategy'
        response = self._send_request(endpoint=endpoint, method='put', form_data=form_data)
        return response

    def get_all_strategies(self) -> dict:
        """
        Get all the Python strategies created by the user on the AlgoBulls platform

        Returns:
            JSON Response received from AlgoBulls platform with list of all the created strategies.

        Info: ENDPOINT
            `GET` v1/build_python_strategy_get_all
        """
        endpoint = f'v1/build_python_strategy_get_all'
        response = self._send_request(endpoint=endpoint)
        return response

    def get_strategy_details(self, strategy_code: str) -> dict:
        """
        Get strategy details for

        Arguments:
            strategy_code: unique code of strategy, which is received while creating the strategy or

        Return:
            JSON

        Info: ENDPOINT
            `GET` v1/build_python_strategy
        """
        params = {'strategy_code': strategy_code}
        endpoint = f'v1/build_python_strategy'
        response = self._send_request(endpoint=endpoint, params=params)
        return response

    def search_instrument(self, instrument: str) -> dict:
        """

        Args:
            instrument:

        Returns:
            JSON Response


        Info: ENDPOINT
            `GET` v1/instrument_search
        """
        params = {'instrument': instrument}
        endpoint = f'v1/instrument_search'
        response = self._send_request(endpoint=endpoint, params=params, requires_authorization=False)
        return response

    def set_strategy_config(self, strategy_code: str, strategy_config: str) -> dict:
        """

        Args:
            strategy_code:
            strategy_config:

        Returns:

        Info: ENDPOINT
           PATCH v1/customer_strategy_tweak
        """
        params = {'strategy_code': strategy_code, 'strategy_type': StrategyType.PYTHON.value}
        form_data = strategy_config
        endpoint = f'v1/customer_strategy_tweak'
        response = self._send_request(method='patch', endpoint=endpoint, params=params, form_data=form_data)
        return response

    def start_strategy_algotrading(self, strategy_code: str, trading_type: str, broker: str = '') -> dict:
        """
        Submit Backtesting / Paper Trading / Real Trading job for strategy with code strategy_code & return the job ID.

        Info: ENDPOINT
            `POST` v1/customer_strategy_algotrading
        """
        params = {'strategy_code': strategy_code, 'strategy_type': StrategyType.PYTHON.value, 'trading_type': trading_type.value, 'broker': broker}
        endpoint = f'v1/customer_strategy_algotrading'
        form_data = {'action': 'start'}
        response = self._send_request(method='post', endpoint=endpoint, params=params, form_data=form_data)
        return response

    def stop_strategy_algotrading(self, strategy_code: str, trading_type: str, broker: str = '') -> dict:
        """
        Stop Backtesting / Paper Trading / Real Trading job for strategy with code strategy_code & return the job ID.

        Info: ENDPOINT
            `POST` v1/customer_strategy_algotrading
        """
        params = {'strategy_code': strategy_code, 'strategy_type': StrategyType.PYTHON.value, 'trading_type': trading_type.value, 'broker': broker}
        endpoint = f'v1/customer_strategy_algotrading'
        form_data = {'action': 'stop'}
        response = self._send_request(method='post', endpoint=endpoint, params=params, form_data=form_data)
        return response

    def get_job_status(self, strategy_code: str, trading_type: str, broker: str = '') -> dict:
        """


        Get status for a BACKTESTING/PAPERTESTING/REALTRADING Job

        Args:
            strategy_code: Strategy code
            trading_type: Trading type
            broker: Name of the broker

        Returns:
            Job status

        Info: ENDPOINT
            `GET` v1/customer_strategy_algotrading
        """
        params = {'strategy_code': strategy_code, 'strategy_type': StrategyType.PYTHON.value, 'trading_type': trading_type.value, 'broker': broker}
        endpoint = f'v1/customer_strategy_algotrading'
        response = self._send_request(endpoint=endpoint, params=params)
        return response

    def get_reports(self, strategy_code: str, trading_type: str, report_type: str, broker: str = '') -> dict:
        """
        Get reports for a BACKTESTING/PAPERTESTING/REALTRADING Job

        Args:
            strategy_code: Strategy code
            trading_type: Value of TradingType Enum
            report_type: Value of TradingReportType Enum
            broker: Name of the broker

        Returns:
            Report data

        Info: ENDPOINT
            `GET` v1/customer_strategy_algotrading_reports
        """
        params = {'strategy_code': strategy_code, 'strategy_type': StrategyType.PYTHON.value, 'trading_type': trading_type.value, 'report_type': report_type.value, 'broker': broker}
        endpoint = f'v1/customer_strategy_algotrading_reports'
        response = self._send_request(endpoint=endpoint, params=params)
        return response
